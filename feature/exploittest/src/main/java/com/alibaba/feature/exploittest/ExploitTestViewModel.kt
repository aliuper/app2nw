package com.alibaba.feature.exploittest

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.alibaba.domain.model.*
import com.alibaba.domain.service.ExploitTester
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import javax.inject.Inject

data class ExploitTestState(
    val panelUrl: String = "",
    val panelPort: String = "8080",
    // GeliÅŸmiÅŸ Exploit Testleri
    val testSqlInjection: Boolean = true,
    val testAuthBypass: Boolean = true,
    val testApiExploit: Boolean = true,
    val testUserIdEnumeration: Boolean = true,
    val testPanelApiExploit: Boolean = true,
    val testConfigLeak: Boolean = true,
    // Eski testler (opsiyonel)
    val testPathTraversal: Boolean = true,
    val testDefaultCredentials: Boolean = false,
    // User ID tarama aralÄ±ÄŸÄ±
    val userIdStart: String = "1",
    val userIdEnd: String = "500",
    val customWordlist: String = "",
    val testing: Boolean = false,
    val progress: ExploitTestProgress? = null,
    val results: List<ExploitTestResult> = emptyList(),
    val errorMessage: String? = null,
    val showDisclaimer: Boolean = true
)

@HiltViewModel
class ExploitTestViewModel @Inject constructor(
    private val exploitTester: ExploitTester
) : ViewModel() {

    private val _state = MutableStateFlow(ExploitTestState())
    val state: StateFlow<ExploitTestState> = _state.asStateFlow()

    private var testJob: Job? = null

    fun setPanelUrl(url: String) {
        _state.update { it.copy(panelUrl = url) }
    }

    fun setPanelPort(port: String) {
        _state.update { it.copy(panelPort = port) }
    }

    fun toggleTestSqlInjection() {
        _state.update { it.copy(testSqlInjection = !it.testSqlInjection) }
    }

    fun toggleTestAuthBypass() {
        _state.update { it.copy(testAuthBypass = !it.testAuthBypass) }
    }

    fun toggleTestApiExploit() {
        _state.update { it.copy(testApiExploit = !it.testApiExploit) }
    }

    fun toggleTestUserIdEnumeration() {
        _state.update { it.copy(testUserIdEnumeration = !it.testUserIdEnumeration) }
    }

    fun toggleTestPanelApiExploit() {
        _state.update { it.copy(testPanelApiExploit = !it.testPanelApiExploit) }
    }

    fun toggleTestConfigLeak() {
        _state.update { it.copy(testConfigLeak = !it.testConfigLeak) }
    }

    fun toggleTestPathTraversal() {
        _state.update { it.copy(testPathTraversal = !it.testPathTraversal) }
    }

    fun toggleTestDefaultCredentials() {
        _state.update { it.copy(testDefaultCredentials = !it.testDefaultCredentials) }
    }

    fun setUserIdStart(value: String) {
        _state.update { it.copy(userIdStart = value) }
    }

    fun setUserIdEnd(value: String) {
        _state.update { it.copy(userIdEnd = value) }
    }

    fun setCustomWordlist(wordlist: String) {
        _state.update { it.copy(customWordlist = wordlist) }
    }

    fun acceptDisclaimer() {
        _state.update { it.copy(showDisclaimer = false) }
    }

    fun startTest() {
        val currentState = _state.value

        if (currentState.panelUrl.isBlank()) {
            _state.update { it.copy(errorMessage = "LÃ¼tfen panel URL'si girin") }
            return
        }

        val port = currentState.panelPort.toIntOrNull() ?: 8080

        testJob?.cancel()
        testJob = viewModelScope.launch {
            _state.update {
                it.copy(
                    testing = true,
                    errorMessage = null,
                    results = emptyList(),
                    progress = null
                )
            }

            try {
                val config = ExploitTestConfig(
                    panelUrl = currentState.panelUrl,
                    panelPort = port,
                    testSqlInjection = currentState.testSqlInjection,
                    testAuthBypass = currentState.testAuthBypass,
                    testApiExploit = currentState.testApiExploit,
                    testUserIdEnumeration = currentState.testUserIdEnumeration,
                    testPanelApiExploit = currentState.testPanelApiExploit,
                    testConfigLeak = currentState.testConfigLeak,
                    testDefaultCredentials = currentState.testDefaultCredentials,
                    testPathTraversal = currentState.testPathTraversal,
                    customWordlist = parseWordlist(currentState.customWordlist),
                    userIdStart = currentState.userIdStart.toIntOrNull() ?: 1,
                    userIdEnd = currentState.userIdEnd.toIntOrNull() ?: 500
                )

                withContext(Dispatchers.IO) {
                    exploitTester.runExploitTest(
                        config = config,
                        onProgress = { progress ->
                            _state.update { it.copy(progress = progress) }
                        },
                        onVulnerabilityFound = { result ->
                            _state.update { it.copy(results = it.results + result) }
                        }
                    )
                }

                _state.update { it.copy(testing = false) }

            } catch (e: CancellationException) {
                _state.update { it.copy(testing = false, errorMessage = "Test durduruldu") }
            } catch (e: Exception) {
                _state.update {
                    it.copy(
                        testing = false,
                        errorMessage = "Hata: ${e.message}"
                    )
                }
            }
        }
    }

    fun stopTest() {
        testJob?.cancel()
        testJob = null
        _state.update { it.copy(testing = false) }
    }

    fun clearResults() {
        _state.update {
            it.copy(
                results = emptyList(),
                progress = null,
                errorMessage = null
            )
        }
    }

    fun clearError() {
        _state.update { it.copy(errorMessage = null) }
    }

    private fun parseWordlist(text: String): List<String> {
        return text.lines()
            .map { it.trim() }
            .filter { it.isNotBlank() && it.contains(":") }
    }

    fun getResultsSummary(): String {
        val results = _state.value.results
        if (results.isEmpty()) return "HiÃ§ aÃ§Ä±k bulunamadÄ±"

        val critical = results.count { it.severity == Severity.CRITICAL }
        val high = results.count { it.severity == Severity.HIGH }
        val medium = results.count { it.severity == Severity.MEDIUM }
        val low = results.count { it.severity == Severity.LOW }
        val credentials = results.mapNotNull { it.foundCredentials }.size

        return buildString {
            appendLine("ðŸ“Š Test Ã–zeti")
            appendLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
            appendLine("ðŸ”´ Kritik: $critical")
            appendLine("ðŸŸ  YÃ¼ksek: $high")
            appendLine("ðŸŸ¡ Orta: $medium")
            appendLine("ðŸŸ¢ DÃ¼ÅŸÃ¼k: $low")
            appendLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
            appendLine("ðŸ”‘ Bulunan Hesap: $credentials")
        }
    }

    fun getDetailedReport(): String {
        val results = _state.value.results
        if (results.isEmpty()) return "Test sonucu yok"

        return buildString {
            appendLine("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
            appendLine("â•‘     PANEL GÃœVENLÄ°K TESTÄ° RAPORU        â•‘")
            appendLine("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            appendLine()
            appendLine("Panel: ${_state.value.panelUrl}:${_state.value.panelPort}")
            appendLine("Tarih: ${java.text.SimpleDateFormat("dd.MM.yyyy HH:mm").format(java.util.Date())}")
            appendLine()
            appendLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
            appendLine()

            results.forEachIndexed { index, result ->
                appendLine("ã€ AÃ§Ä±k #${index + 1} ã€‘")
                appendLine("TÃ¼r: ${result.vulnerability.displayName}")
                appendLine("Seviye: ${result.severity.displayName}")
                appendLine("AÃ§Ä±klama: ${result.description}")
                appendLine()
                appendLine("ðŸ“Œ YÃ¶ntem:")
                appendLine(result.exploitMethod)
                appendLine()

                result.foundCredentials?.let { cred ->
                    appendLine("ðŸ”‘ Bulunan Hesap:")
                    appendLine("   KullanÄ±cÄ±: ${cred.username}")
                    appendLine("   Åžifre: ${cred.password}")
                    cred.userInfo?.let { info ->
                        appendLine("   Durum: ${info.status}")
                        appendLine("   BitiÅŸ: ${info.expDate ?: "Belirsiz"}")
                        appendLine("   Max BaÄŸlantÄ±: ${info.maxConnections}")
                    }
                    appendLine()
                }

                appendLine("ðŸ’¡ Ã–neri:")
                appendLine(result.recommendation)
                appendLine()
                appendLine("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
                appendLine()
            }
        }
    }
}
